# Backend - Simon Chatbot API

A FastAPI-based backend service for the Simon Chatbot personal AI assistant application.

## Features

- **FastAPI REST API** with automatic OpenAPI documentation
- **Supabase Integration** for database operations
- **Multi-Model AI System** with intelligent model selection:
  - **Chat**: GPT-5 mini
  - **Descriptions**: Google Gemini Pro
  - **Scripts**: GPT-5
  - **Scenes**: Claude 3 Sonnet
- **Structured Data Models** using Pydantic
- **Environment Configuration** with .env support
- **Auto-reload Development Server**

## Prerequisites

- Python 3.8+
- Supabase account and project
- OpenAI API key
- Google Gemini API key (for descriptions)
- Anthropic Claude API key (for scenes)

## Installation

1. **Navigate to the backend directory:**
   ```bash
   cd backend
   ```

2. **Install dependencies:**
   ```bash
   pip install -r requirements.txt
   ```

3. **Set up environment variables:**
   Create a `.env` file in the backend directory with the following variables:
   ```env
   SUPABASE_URL=your_supabase_project_url
   SUPABASE_KEY=your_supabase_anon_key
   OPENAI_API_KEY=your_openai_api_key
   GEMINI_API_KEY=your_gemini_api_key
   ANTHROPIC_API_KEY=your_anthropic_api_key
   
   # LangSmith Monitoring (Optional but recommended)
   LANGSMITH_API_KEY=your_langsmith_api_key
   LANGSMITH_PROJECT=simon-chatbot
   LANGSMITH_TRACING_V2=true
   ```

## Database Setup

1. **Install Supabase CLI** (if not already installed):
   ```bash
   # Using Scoop (Windows)
   scoop install supabase
   
   # Or using npm
   npm install -g supabase
   ```

2. **Initialize Supabase project:**
   ```bash
   supabase init
   ```

3. **Start local Supabase services:**
   ```bash
   supabase start
   ```

4. **Run database migrations:**
   ```bash
   supabase db push
   ```

## Running the Application

### Development Mode (with auto-reload)

```bash
uvicorn app.main:app --reload
```

The server will start on `http://127.0.0.1:8000`

### Production Mode

```bash
uvicorn app.main:app --host 0.0.0.0 --port 8000
```

## API Documentation

Once the server is running, you can access:

- **Interactive API Docs (Swagger UI)**: `http://127.0.0.1:8000/docs`
- **Alternative API Docs (ReDoc)**: `http://127.0.0.1:8000/redoc`
- **OpenAPI Schema**: `http://127.0.0.1:8000/openapi.json`

## API Endpoints

### Chat Endpoint

**POST** `/chat`

Send a chat message and receive a response using GPT-5 mini.

**Request Body:**
```json
{
  "text": "Your message here"
}
```

**Response:**
```json
{
  "reply": "AI-generated response",
  "metadata_json": {
    "turn_id": "uuid",
    "project_id": "uuid", 
    "raw_text": "original message",
    "normalized": {
      "text": "processed text",
      "metadata": "structured data",
      "ai_model": "gpt-5-mini",
      "tokens_used": 150
    }
  }
}
```

### Description Generation

**POST** `/generate-description`

Generate detailed descriptions using Google Gemini Pro.

**Request Body:**
```json
{
  "text": "Describe a mysterious forest scene"
}
```

**Response:**
```json
{
  "description": "Detailed description generated by Gemini",
  "model_used": "gemini-pro",
  "tokens_used": 200
}
```

### Script Generation

**POST** `/generate-script`

Generate scripts using GPT-5.

**Request Body:**
```json
{
  "text": "Write a dialogue between two characters"
}
```

**Response:**
```json
{
  "script": "Generated script content",
  "model_used": "gpt-5",
  "tokens_used": 500
}
```

### Scene Generation

**POST** `/generate-scene`

Generate detailed scenes using Claude 3 Sonnet.

**Request Body:**
```json
{
  "text": "Create a dramatic confrontation scene"
}
```

**Response:**
```json
{
  "scene": "Detailed scene description",
  "model_used": "claude-3-sonnet-20240229",
  "tokens_used": 400
}
```


## Project Structure

```
backend/
├── app/
│   ├── ai/
│   │   └── models.py        # AI model management system
│   ├── api/
│   │   └── chat.py          # Chat and generation API endpoints
│   ├── database/
│   │   ├── supabase.py      # Supabase client configuration
│   │   └── supabase/
│   │       └── migrations/  # Database migration files
│   ├── main.py              # FastAPI application entry point
│   └── models.py            # Pydantic data models
├── .env                     # Environment variables (create this)
├── requirements.txt         # Python dependencies
└── README.md               # This file
```

## Data Models

### ChatRequest
- `text: str` - The user's input message

### ChatResponse  
- `reply: str` - The AI-generated response
- `metadata_json: Dict[str, Any]` - Structured metadata about the conversation

### SubmissionMetadata
- `turn_id: str` - Unique identifier for the conversation turn
- `project_id: str` - Project identifier
- `raw_text: str` - Original user input
- `normalized: Dict[str, Any]` - Processed and structured data

### SceneMetadata
- `scene_id: str` - Unique scene identifier
- `description: Optional[str]` - Scene description
- `interior_exterior: Optional[str]` - Location type
- `time_of_day: Optional[str]` - Time setting
- `tone: Optional[str]` - Scene tone/mood

### Dossier
- `title: Optional[str]` - Project title
- `logline: Optional[str]` - Story logline
- `genre: Optional[str]` - Story genre
- `tone: Optional[str]` - Overall tone
- `scenes: List[SceneMetadata]` - List of scenes

## Environment Variables

| Variable | Description | Required |
|----------|-------------|----------|
| `SUPABASE_URL` | Your Supabase project URL | Yes |
| `SUPABASE_KEY` | Your Supabase anon/public key | Yes |
| `OPENAI_API_KEY` | Your OpenAI API key | Yes |
| `GEMINI_API_KEY` | Your Google Gemini API key | Yes |
| `ANTHROPIC_API_KEY` | Your Anthropic Claude API key | Yes |
| `LANGSMITH_API_KEY` | Your LangSmith API key for monitoring | No |
| `LANGSMITH_PROJECT` | LangSmith project name (defaults to "simon-chatbot") | No |
| `LANGSMITH_TRACING_V2` | Enable LangSmith tracing v2 (defaults to "true") | No |

### LangSmith Setup (Optional)

LangSmith provides monitoring and observability for your AI operations. To enable it:

1. **Get your LangSmith API key:**
   - Sign up at [https://smith.langchain.com](https://smith.langchain.com) (free tier available)
   - Go to Settings → API Keys
   - Create a new API key or copy an existing one

2. **Add to your `.env` file:**
   ```env
   LANGSMITH_API_KEY=lsv2_pt_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
   LANGSMITH_PROJECT=simon-chatbot
   LANGSMITH_TRACING_V2=true
   ```

3. **What gets monitored:**
   - All OpenAI chat completions (with full prompts and responses)
   - All OpenAI embedding generations
   - RAG context retrieval operations
   - Document processing operations
   - Token usage, latency, and error tracking

4. **View your traces:**
   - Visit [https://smith.langchain.com](https://smith.langchain.com)
   - Navigate to your project (default: "simon-chatbot")
   - View real-time traces, filter by tags, and analyze performance

**Note:** LangSmith is optional. If you don't set `LANGSMITH_API_KEY`, the application will run normally without monitoring.

## Development

### Adding New Endpoints

1. Create new router in `app/api/`
2. Import and include in `app/main.py`
3. Add corresponding models in `app/models.py`

### Database Changes

1. Create migration files in `app/database/supabase/migrations/`
2. Update models in `app/models.py`
3. Run `supabase db push` to apply changes

## Troubleshooting

### Common Issues

1. **ModuleNotFoundError**: Make sure you're running from the backend directory
2. **Supabase Connection Error**: Verify your `.env` file has correct credentials
3. **OpenAI API Error**: Check your API key and billing status

### Logs

The application logs connection status and errors to the console. Look for:
- `Connected to Supabase!` - Successful database connection
- `Error connecting to Supabase: {error}` - Database connection issues

## Contributing

1. Follow PEP 8 style guidelines
2. Add type hints to all functions
3. Update this README when adding new features
4. Test all endpoints before submitting changes

## License

This project is part of the Simon Chatbot application suite.

